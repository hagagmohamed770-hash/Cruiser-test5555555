#!/bin/bash

echo "๐ ุจุฏุก ุชุดุบูู ูุธุงู ุฅุฏุงุฑุฉ ุงูุงุณุชุซูุงุฑ ุงูุนูุงุฑู v5.0.0"
echo "================================================"

# ุงูุชุญูู ูู ูุฌูุฏ Node.js
if ! command -v node &> /dev/null; then
    echo "โ Node.js ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช Node.js ุฃููุงู."
    exit 1
fi

# ุงูุชุญูู ูู ูุฌูุฏ npm
if ! command -v npm &> /dev/null; then
    echo "โ npm ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช npm ุฃููุงู."
    exit 1
fi

echo "โ Node.js ู npm ูุซุจุชุงู"

# ุชุซุจูุช ุงูุชุจุนูุงุช ุฅุฐุง ูู ุชูู ูุซุจุชุฉ
if [ ! -d "node_modules" ]; then
    echo "๐ฆ ุชุซุจูุช ุงูุชุจุนูุงุช..."
    npm install
    if [ $? -ne 0 ]; then
        echo "โ ูุดู ูู ุชุซุจูุช ุงูุชุจุนูุงุช"
        exit 1
    fi
    echo "โ ุชู ุชุซุจูุช ุงูุชุจุนูุงุช ุจูุฌุงุญ"
else
    echo "โ ุงูุชุจุนูุงุช ูุซุจุชุฉ ุจุงููุนู"
fi

# ุฅูุดุงุก ูุฌูุฏ ุงูุจูุงูุงุช ุฅุฐุง ูู ููู ููุฌูุฏุงู
if [ ! -d "data" ]; then
    echo "๐ ุฅูุดุงุก ูุฌูุฏ ุงูุจูุงูุงุช..."
    mkdir -p data
fi

# ุฅูุดุงุก ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุฅุฐุง ูู ููู ููุฌูุฏุงู
if [ ! -d "backups" ]; then
    echo "๐ ุฅูุดุงุก ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ..."
    mkdir -p backups
fi

echo "๐ง ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
node -e "
const Database = require('./database/database');
const db = new Database();
db.initialize().then(() => {
    console.log('โ ุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ');
    process.exit(0);
}).catch(err => {
    console.error('โ ูุดู ูู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
    process.exit(1);
});
"

if [ $? -ne 0 ]; then
    echo "โ ูุดู ูู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช"
    exit 1
fi

echo ""
echo "๐ ุจุฏุก ุชุดุบูู ุงูุฎุงุฏู..."
echo "๐ ููููู ุงููุตูู ููุชุทุจูู ุนูู: http://localhost:3000"
echo "๐ ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู ุงูุงูุชุฑุงุถูุฉ:"
echo "   ุงุณู ุงููุณุชุฎุฏู: admin"
echo "   ูููุฉ ุงููุฑูุฑ: admin123"
echo ""
echo "โน๏ธ  ุงุถุบุท Ctrl+C ูุฅููุงู ุงูุฎุงุฏู"
echo ""

# ุชุดุบูู ุงูุฎุงุฏู
npm start